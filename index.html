<!doctype html>
<meta charset="utf-8">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<style type="text/css">
    #top {
        height:5vh;
    }
    #main {
        height:50vh;
    }
    #leftspace {
        float:left;
        width:5%;
        height:70vh;
    }
    #leftbox { 
                float:left;  
                width:20%; 
                height:70vh; 
            } 
            #middlebox{ 
                float:left;  
                width:70%; 
                height:70vh; 
            } 
            #rightspace{ 
                float:left;  
                width:5%; 
                height:70vh; 
            } 
    #page_button {
        float:left;  
        width:20%; 
        /*height:10vh; */
    }
    #graph_title {
        float:left;  
        width:70%; 
        /*height:10vh; */
    }


/* 13. Basic Styling with CSS */
.tooltip {
  position: absolute;
  text-align: left;
  width: 200px;
  height: 40px;
  padding: 8px;
  margin-top: -20px;
  font: 15px sans-serif;
  pointer-events: none;
  background: rgba(255, 255, 255, .8);
}

/* Style the lines by removing the fill and applying a stroke */
.line {
    fill: none;
    /*stroke: #ffab00;*/
    stroke-width: 3;
}
  
.overlay {
  fill: none;
  pointer-events: all;
}

/* Style the dots by assigning a fill and stroke */
.dot {
    /*fill: #ffab00;*/
    stroke: #fff;
}
  
.focus circle {
  fill: none;
  stroke: steelblue;
}
body{
        background-color: whitesmoke;
     }

    :root {
      --line-chart-color: #607D8B;
      --annotation-context-color: #00796B;
      --annotation-above-color: #00BFA5;
      --annotation-anomaly-color: #E8336D;
    }

    /* svg {
        background-color: white;
        font-family: 'Lato';
     }

     .axis, .axis text {
       fill: var(--line-chart-color);
     }

     .axis line, path {
      stroke: var(--line-chart-color);
     }

     path {
       fill: none;
     }*/

    .annotation path {
      stroke: var(--annotation-context-color);
    }

    .annotation:not(.above):not(.anomaly) path {
      stroke-dasharray: 1,3;
    }

    .annotation text {
      fill: var(--annotation-context-color);
    }

    .annotation.above path {
      stroke: var(--annotation-above-color);
    }

    .annotation.above text {
      fill: var(--annotation-above-color);
    }

    .annotation.anomaly path {
      stroke: var(--annotation-anomaly-color);
      stroke-width: 2px;
    }

    .annotation.anomaly text {
      fill: var(--annotation-anomaly-color);
    }

    .annotation-note-bg {
      fill: rgba(0, 0, 0, 0);
    }

    .annotation-note-title {
      font-weight: bold;
    }

   /* text.title {
      font-size: 1.2em;
      font-weight: bold;
    }*/

/*
.legend rect {
  fill:white;
  stroke:black;
  opacity:0.8;}*/

</style>
<html>
<script src="https://d3js.org/d3.v5.min.js"></script>
<!-- annotation, but built on d3/d4-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.3.2/d3-annotation.js"></script>

<!-- bootstrap-->
 <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

<script src="https://d3js.org/d3-time.v1.min.js"></script>
<script src="https://d3js.org/d3-time-format.v2.min.js"></script>

<script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
<script src="https://d3js.org/d3-ease.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-selection.v1.min.js"></script>
<script src="https://d3js.org/d3-timer.v1.min.js"></script>
<script src="https://d3js.org/d3-transition.v1.min.js"></script>

  <head>
    <title>World Suicide Rate from 1985~2016</title>
  </head>
  <body>
   
        <h3>World Suicide Rate from 1985~2016 </h3>
        <div id = "top">
            <div id = "page_button">
                <button id = "bn" type="button" class="btn btn-outline-dark btn-sm"  onclick="nextPage(-1)"><</button>
                <button id = "b1" type="button" class="btn btn-outline-dark btn-sm active" onclick="gotoPage(1)">1</button>
                <button id = "b2" type="button" class="btn btn-outline-dark btn-sm " onclick="gotoPage(2)">2</button>
                <button id = "b3" type="button" class="btn btn-outline-dark btn-sm " onclick="gotoPage(3)">3</button>
                <button id = "nb" type="button" class="btn btn-outline-dark btn-sm " onclick="nextPage(1)">></button>
            </div>
            <div id = "graph_title">
            </div>
        </div>
        
        <div id = "main">
            <!-- <div id = "leftspace"></div> -->
            <div id = "leftbox"></div>
            <div id = "middlebox"></div>
            <!-- <div id = "rightspace"></div> -->
        </div>
        
    
    <script type="text/javascript">
		// Set the dimensions of the canvas / graph
        var margin = {top:80, right: 80, bottom: 50, left:180}
            , width = document.getElementById('middlebox').clientWidth - margin.left - margin.right
            , height = document.getElementById('middlebox').clientHeight - margin.top - margin.bottom;
        
        var svg = d3.select("#middlebox").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("display", "none");

        var xs = d3.scaleTime()
            .range([0, width]);

        var ys = d3.scaleLinear()
            .range([height, 0]);
        var colors = d3.scaleOrdinal()
            .range(d3.schemeCategory10);

        // draw lines for each group
        var line = d3.line()
            .x(function(d) {return xs(d.Year);})
            .y(function(d) {return ys(d.Avg_Suicides_per_100K_Pop);})
            .curve(d3.curveMonotoneX);
        
        // transition parameter
        var t = 1000;

        var parseTime = d3.timeParse("%Y");
        var formatTime = d3.timeFormat("%Y")

        

        // common mouse function
        function mouseover()  {
            tooltip.transition().duration(300).style("opacity", 0.9).style("display", "inline");
        }
        function mouseout() {
            tooltip.transition()        
                .duration(500)      
                .style("opacity", 0)
                .style("display", "none");  
        }

        function label_axes() {
            // axis labels
            svg.append("text")             
              .attr("transform",
                    "translate(" + (width/2) + " ," + 
                                   (height + margin.top + 20) + ")")
              .style("text-anchor", "middle")
              .text("Year");

            svg.append("text")             
              .attr("transform", "rotate(-90)")
              .attr("y", 0 - margin.left/3)
              .attr("x", 0 - (height/2))
              .attr("dy", "1em")
              .style("text-anchor", "middle")
              .text("Avg Suicides Per 100K Pop");
        }

        function clear_graph() {
            svg.selectAll("*").remove();
            d3.selectAll("#graph_title > *").remove();
            d3.selectAll("#leftbox > *").remove();     
        }
        
        // Page Control Logic
        var page_num = 1;
        var pages = 3;
        gotoPage(page_num);

        // go to specific page based on the page number
        function gotoPage(num) {
            // Clear graphs, deselect button
            var old_button = document.getElementById("b" + page_num.toString());
            old_button.className = old_button.className.replace(" active", "")

            // old_button.setAttribute("aria-pressed", false);
            clear_graph();

            // Load new pages, select button
            console.log("go to page:" + num);
            page_num = num;
            var new_button = document.getElementById("b" + page_num.toString());
            new_button.className += " active";

            switch(page_num) {
                case 1:
                    load_suicides_year();
                    break;
                case 2:
                    load_suicides_age_year();
                    break;
                case 3:
                    load_suicide_sex();
                    break;
                default:
                    load_suicides_year();
                    break;
            }
            label_axes();
        }
        function nextPage(offset) {
            prev_page_num = page_num
            next_page_num  = page_num + offset;
            if (next_page_num > pages) {
                next_page_num = pages;
            }
            else if (next_page_num < 1) {
                next_page_num = 1;
            }
            if (next_page_num != prev_page_num) {
                gotoPage(next_page_num);
            }
            
        }

        // load suicde_country dadta
        function load_suicides_country() {
            d3.select("#middlebox").html = "";
            d3.csv("data/suicides_country.csv").then(function(data) {
                console.log(data);
                data = data.reverse();
                var maxdata = data[0]['Avg. Suicides_per_100K_Pop'];
                var textlen = 200;
                var margin = 50;
                console.log('max country', data[0].Country)
                var xs = d3.scaleLinear().domain([0, parseFloat(maxdata)]).range([0, width-textlen-margin]);
                var height = 20 * data.length;

                svg.attr("height", height + 30)

                svg.selectAll("rect")
                    .data(data)
                    .enter()
                    .append("rect")
                        .attr("x", textlen)
                        .attr("y", function(d, i) {return i * 20 + 20;})
                        .attr("width", function(d) {return xs(d['Avg. Suicides_per_100K_Pop']) ;})
                        .attr("height", 18)
                        .attr("fill", d3.color("steelblue"))
                        .on("mouseover", function(d) {
                            d3.select(this).attr("stroke", "black");
                            // tooltip.transition().duration(300).style("opacity", 0.9).style("display", "inline");
                            tooltip.html(d.Country + " Suicide Rate:" + d['Avg. Suicides_per_100K_Pop'] + " pp")
                                .style("display", "inline")
                                .style("left", d3.event.pageX + 50 + "px")
                                .style("top", d3.event.pageY +20 + "px");
                            return mouseover();
                        })
                        .on("mouseout", function(d) {   
                            d3.select(this).attr("stroke", "none"); 
                            return mouseout();
                        });
                
                svg.selectAll("text")
                    .data(data)
                    .enter()
                    .append("text")
                        .attr("x", 10)
                        .attr("y", function(d, i) {return i * 20 + 35;})
                        .text(function(d) {return d.Country;})
                        .attr("font-size", "17px")
                        .attr("fill", "black");
            });
        }
       
        function load_suicide_sex() {
            d3.csv("data/suicides_sex_year.csv").then(function(data) {      
            // d3.csv("data/suicides_sex_year.csv", function(data) {      
                // write title of graph
                var title = d3.select("#graph_title").append("h2")
                    .text("Avereage Suicide Rates Per Sex Per Year")
                    .attr("align", "center");

                // Add information to the graph to guide use
                var header = d3.select("#leftbox").append("h4")
                    .text("Which Sex Has The Highest Suicide Rate?")
                    .attr("align", "left")
                var info = d3.select("#leftbox").append("p")
                    .text("\n \n Men account for at least 70% of the suicide rate. This trend is the same in all years. ")
                    .attr("align", "left")
                
                // Process Data
                console.log(data);

                var dataMap = new Map();
                data.forEach(function(d) {
                    d.Suicide_Rate = +d.Suicide_Rate;

                    var obj = {
                        "year": d.Year,
                        "male" : 0,
                        "female" : 0
                    };

                    if (dataMap.has(d.Year)) {
                        obj = dataMap.get(d.Year);
                    }

                    if (d.Sex == "male") {
                        obj.male = d.Suicide_Rate;
                    }
                    else {
                        obj.female = d.Suicide_Rate;
                    }

                    dataMap.set(d.Year , obj);
                   
                });
 
                var dataObj = Array.from(dataMap.values());
                console.log("datamap", dataMap);

                var stack = d3.stack()
                    .keys(["male", "female"])
                    .order(d3.stackOrderNone)
                    .offset(d3.stackOffsetNone);

                var series = stack(dataObj);
                // transition before
                xs.domain(d3.extent(dataObj, function(d) { return (parseTime(d.year));}));
                ys.domain([0,  0]);      

                var groups = svg.selectAll("g.sex")
                    .data(series)
                    .enter().append("g")
                    .style("fill", function(d, i) {return colors(d.key);})

                var rect = groups.selectAll("rect")
                    .data(function(d) { return d; })
                    .enter()
                    .append("rect")
                    .attr("x", function(d) { return xs(parseTime(d.data.year)); })
                    .attr("y", function(d) { return ys(d[1]) ; })
                    .attr("height", function(d) { return  height - ys(d[1] - d[0]); })
                    .attr("width", width/dataObj.length - 5)
                    .on("mouseover", function(d) { 
                        d3.select(this).style("stroke", "black");
                        var sex = "Female";
                        if (d[0] == 0) {
                            sex = "Male";
                        }
                        tooltip.html("Year: " + d.data.year + "<br>Sex: " + sex +  "<br>Suicide Rate: " + (d[1] - d[0]).toFixed(2))
                            .style("height", "70px")
                            .style("width", "150px")
                            .style("display", "inline")
                            .style("left", d3.event.pageX + 10 + "px")
                            .style("top", d3.event.pageY +20 + "px");
                        return mouseover();
                    })
                    .on("mouseout", function() { 
                        d3.select(this).style("stroke", "none");
                        return mouseout();})

                // transition after
                ys.domain([0,  d3.max(dataObj, function(d) { return d.male + d.female;})]);     
                rect.transition().duration(t)
                    .attr("y", function(d) { return ys(d[1]) ; })
                    .attr("height", function(d) { return  height - ys(d[1] - d[0]); })
                // Create an axis component with d3.axisBottom
                var xaxis = svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(xs)); 
                // Create an axis component with d3.axisLeft
                var yaxis = svg.append("g")
                    .attr("class", "y axis")
                    .call(d3.axisLeft(ys)); 

                // annotations
            //     const annotations = [{
            //         note: { label: "70%+ Suicides Are Men ", wrap: 100},
            //         disable: ["connector"],
            //         data: {Avg_Suicides_per_100K_Pop: dataMap.get('1985').male},
            //         subject: {
            //           x1: xs(parseTime("1985")),
            //           x2: xs(parseTime("2000"))
            //         },
            //         x : xs(parseTime("1985")) + margin.left,
            //         dx: 0, dy:0,
            //         }
            //     ]

            //     const type = d3.annotationCustomType(
            //         d3.annotationXYThreshold, 
            //         {"note":{
            //             "lineType":"none",
            //             "orientation": "left",
            //             "align":"top"
            //             // "background-color": "whitesmoke"
            //             }
            //         }
            //       )
            //     d3.annotation().annotations(annotations);
            //     const makeAnnotations = d3.annotation()
            //                 .type(type)
            //                 // .type(d3.annotationXYThreshold)
            //                 //Gives you access to any data objects in the annotations array
            //                 .accessors({ 
            //                   x: function(d){ return xs(parseTime(d.Year))},
            //                   y: function(d){ return ys(d.Avg_Suicides_per_100K_Pop ) }
            //                 })
            //                 .accessorsInverse({
            //                      year: d => timeFormat(xs.invert(d.Year)),
            //                      rate: d => ys.invert(d.Avg_Suicides_per_100K_Pop)
            //                   })
            //                 .annotations(annotations)
            //                 // .textWrap(60)

            //     var anno = svg.append("g")
            //         .call(makeAnnotations);
            //     anno
            //         .transition()
            //             .style("display", "none")
            //         .transition()
            //             .delay(t)
            //             .style("display", "inline");

            })
        }
        // load suicides_year data
        function load_suicides_year() {
            d3.csv("data/suicides_year.csv").then(function(data) {            
                // d3.csv("data/suicides_year.csv", function(data) {            

                // write title of graph
                var title = d3.select("#graph_title").append("h2")
                    .text("Avereage Suicide Rates Per Year")
                    .attr("align", "center");

                // Add information to the graph to guide use
                var header = d3.select("#leftbox").append("h4")
                    .text("What Year Has The Highest Suicide Rate?")
                    .attr("align", "left")
                var info = d3.select("#leftbox").append("p")
                    .text("\n \n The average suicide rate slowly climbs up from 1985 to 1995. In 1995 it has the highest suicide rate followed by a slow steady decline. However notice the inflection point in 2015. In 2016 the suicide rate again climbs back up")
                    .attr("align", "left")
                
                

                data.forEach(function(d) {
                    d.Year = parseTime(d.Year);
                    d.Avg_Suicides_per_100K_Pop = +d.Avg_Suicides_per_100K_Pop;
                });
                console.log(data);

                xs.domain(d3.extent(data, function(d) {return d.Year;}));
                ys.domain([0, 0]);

                // transition before 
                var paths = svg.append("path")
                    .datum(data)
                    .attr("class", "line")
                    .attr("d", line)
                    .attr("stroke", "steelblue");

                var circle = svg.selectAll(".dot")
                    .data(data)
                  .enter().append("circle") // Uses the enter().append() method
                    .attr("class", "dot") // Assign a class for styling
                    .attr("cx", function(d, i) { return xs((d.Year)) })
                    .attr("cy", function(d) { return ys(d.Avg_Suicides_per_100K_Pop) })
                    .attr("fill", "steelblue")
                    .attr("r", 5)
                     .on("mouseout", function() {
                        d3.select(this)
                        .style("stroke", "none");
                        return mouseout();
                      })
                      .on("mouseover", function(d) {
                            d3.select(this)
                                .style("stroke", "black");
                                tooltip.html("Year: " + formatTime(d.Year) +  "<br>Suicide Rate: " + d['Avg_Suicides_per_100K_Pop'].toFixed(2))
                                .style("display", "inline")
                                .style("left", d3.event.pageX + 10 + "px")
                                .style("top", d3.event.pageY +20 + "px");
                            return mouseover();

                        });;

                // transition after
                ys.domain([0, 10 + d3.max(data, function(d) {return d.Avg_Suicides_per_100K_Pop;})]);

                paths.transition().duration(t)
                    .attr("class", "line")
                    .attr("d", line);

                circle.transition().duration(t)
                    .attr("class", "dot")
                    .attr("cy", function(d) { return ys(d.Avg_Suicides_per_100K_Pop) })
            
                // Create an axis component with d3.axisBottom
                var xaxis = svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(xs)); 
                // Create an axis component with d3.axisLeft
                var yaxis = svg.append("g")
                    .attr("class", "y axis")
                    .call(d3.axisLeft(ys)); 

                // make annotations
                const annotations = [
                {
                    note: { label: "Cold War Ends" },
                    subject: {
                      y1: margin.top,
                      y2: height - margin.bottom
                    },
                    y: margin.top ,
                    data: { Year: "1985"}, //position the x based on an x scale
                    dy: -50
                },
                {
                    note: { label: "Soviet Union Collapses" },
                    subject: {
                      y1: margin.top,
                      y2: height - margin.bottom
                    },
                    y: margin.top ,
                    data: { Year: "1991"}, //position the x based on an x scale
                    dy: -50
                },
                {
                    note: { label: "September 11 Terrorist attack" },
                    subject: {
                      y1: margin.top,
                      y2: height - margin.bottom
                    },
                    y: margin.top ,
                    data: { Year: "2001"}, //position the x based on an x scale
                    dy: -50
                },
                {
                    note: { label: "Economy Collapses" },
                    subject: {
                      y1: margin.top,
                      y2: height - margin.bottom
                    },
                    y: margin.top ,
                    data: { Year: "2008"}, //position the x based on an x scale
                    dy: -50
                },
                {
                    note: { label: "Syrian Civil War Starts" },
                    subject: {
                      y1: margin.top,
                      y2: height - margin.bottom
                    },
                    y: margin.top ,
                    data: { Year: "2011"}, //position the x based on an x scale
                    dy: 0
                },
                // {
                //     note: { label: "1995 Highest Suicide Rate"},
                //     data: {Year: "1995", Avg_Suicides_per_100K_Pop: ys.domain()[1]},
                //     dx: 50, dy:50,
                //     subject: { radius: 30, radiusPadding: 10 }
                // },
                // {
                //     note: { label: "2015 Lowest Suicide Rate"},
                //     data: {Year: "2015", Avg_Suicides_per_100K_Pop: 11.09},
                //     dx: -50, dy:50,
                //     subject: { radius: 30, radiusPadding: 10 }
                // }
                ]

                const type = d3.annotationCustomType(
                    d3.annotationXYThreshold, 
                    {"note":{
                        "lineType":"none",
                        "orientation": "top",
                        "align":"left"}
                    }
                )
                d3.annotation().annotations(annotations);
                const makeAnnotations = d3.annotation()
                            // .type(d3.annotationCalloutCircle)
                            .type(type)
                            //Gives you access to any data objects in the annotations array
                            .accessors({ 
                              x: function(d){ return xs(parseTime(d.Year))},
                              y: function(d){ return ys(d.Avg_Suicides_per_100K_Pop ) }
                            })
                            .accessorsInverse({
                                 year: d => timeFormat(xs.invert(d.Year)),
                                 rate: d => ys.invert(d.Avg_Suicides_per_100K_Pop)
                              })
                            .annotations(annotations)
                            .textWrap(100)


                var anno = svg.append("g")
                    .attr("class", "annotation-group")
                    .call(makeAnnotations);
                anno
                    .transition()
                        .style("display", "none")
                    .transition()
                        .delay(t)
                        .style("display", "inline");
            });
        }


        // load suicides_year data
        function load_suicides_age_year() {
            d3.csv("data/suicides_age_year.csv").then(function(data) {
                // d3.csv("data/suicides_age_year.csv", function(data) {

                // write title of graph
                var title = d3.select("#graph_title").append("h2")
                    .text("Avereage Suicide Rates Per Age Per Year")
                    .attr("align", "center");

                // Add information to the graph to guide use
                var header = d3.select("#leftbox").append("h4")
                    .text("What Age Group Has The Highest Suicide Rate?")
                    .attr("align", "left")
                var info = d3.select("#leftbox").append("p")
                    .text("Age group 75+ has the highest suicide rate amonst all age groups. However note that in 1995 there's a bump in suicide rate across all age groups")
                    .attr("align", "left")
                    
                // create separate lines for each age bucket
                data.forEach(function(d) {
                    d.Year = parseTime(d.Year);
                    d.Avg_Suicides_per_100K_Pop = +d.Avg_Suicides_per_100K_Pop;
                });
                
                // sort data using Age
                var dataByAge = d3.nest()
                    .key(function(d) {
                        return d.Age;
                    })
                    .entries(data);
                console.log("data by age");
                console.log(dataByAge);

                xs.domain(d3.extent(data, function(d) {return d.Year;}));
                ys.domain([0, 0]);
                console.log('extend', d3.extent(dataByAge, function(d) {return d.key;}))
                colors.domain(d3.extent(dataByAge, function(d) {return d.key;}))
                // transition before
                // draw line using a different color using Age 
                var ageGroups = svg.selectAll(".ageGroups")
                    .data(dataByAge)
                    .enter()
                    .append("g")
                    .attr("stroke", function(d, i) {return colors(d.key)});

                var lines = ageGroups
                    .append("path")
                        .attr("class", "line")
                        .attr('d', function(d) {return line(d.values)})
                
                // Appends a circle for each datapoint 
                var circles = ageGroups.selectAll(".circle")
                    .data(function(d) {
                        return d.values
                    })
                    .enter()
                    .append("circle")
                        .attr("class", "dot") // Assign a class for styling
                        .attr("cx", function(d) { return xs(d.Year); })
                        .attr("cy", function(d) { return ys(d.Avg_Suicides_per_100K_Pop); })
                        .attr("fill", function(d) {return colors(d.Age);})
                        .attr("r", 5)
                          // .on("mouseout", mouseout)
                          .on("mouseout", function() {
                            d3.select(this)
                            .style("stroke", "none");
                            return mouseout();
                          })
                          .on("mouseover", function(d) {
                            d3.select(this)
                            .style("stroke", "black");
                            tooltip.html("Year: " + formatTime(d.Year) + "<br>Age: " + d.Age +  "<br>Suicide Rate: " + d['Avg_Suicides_per_100K_Pop'].toFixed(2))
                            .style("display", "inline")
                            .style("left", d3.event.pageX + 10 + "px")
                            .style("top", d3.event.pageY +20 + "px");

                            return mouseover();
                            });

                // transition after
                ys.domain([0, d3.max(data, function(d) {return d.Avg_Suicides_per_100K_Pop;})]);
                lines.transition().duration(t)
                    .attr("d", function(d) {return line(d.values)});
                circles.transition().duration(t)
                    .attr("cy", function(d) { return ys(d.Avg_Suicides_per_100K_Pop); });

                // Create an axis component with d3.axisBottom
                var xaxis = svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(xs)); 
                // Create an axis component with d3.axisLeft
                var yaxis = svg.append("g")
                    .attr("class", "y axis")
                    .call(d3.axisLeft(ys)); 

                // Create legend for graph
                var legendSpacing = 3;
                var legendRectSize = 20;

                var legend = svg.selectAll('.legend')
                    .data(colors.domain())
                    .enter()
                    .append('g')
                    .attr('class', 'legend')
                    .attr('transform', function(d, i) {
                        var legendHeight = legendRectSize + legendSpacing;       
                        var offset =  legendHeight * colors.domain().length / 2;    
                        var horz = - margin.left;                       
                        var vert = i * legendHeight - offset + height/2;                      
                        return 'translate(' + horz + ',' + vert + ')';
                });

                legend.append('rect')
                    .attr('width', legendRectSize)
                    .attr('height', legendRectSize)
                    .style('fill', colors)
                    .style('stroke', colors);

                legend.append('text')
                        .attr("x", legendRectSize + legendSpacing)
                        .attr('y', legendRectSize + legendSpacing)
                        .text(function(d) {return d;});

                // annotations
                // make annotations
                const annotations = [{
                    note: { label: "Age 75+ Highest Suicide Rate"},
                    data: {Year: "1995", Avg_Suicides_per_100K_Pop: ys.domain()[1]},
                    dx: 200, dy:0,
                    subject: { radius: 30, radiusPadding: 10 }
                }]


                d3.annotation().annotations(annotations);
                const makeAnnotations = d3.annotation()
                            .type(d3.annotationCalloutCurve)
                            //Gives you access to any data objects in the annotations array
                            .accessors({ 
                              x: function(d){ return xs(parseTime(d.Year))},
                              y: function(d){ return ys(d.Avg_Suicides_per_100K_Pop ) }
                            })
                            .accessorsInverse({
                                 year: d => timeFormat(xs.invert(d.Year)),
                                 rate: d => ys.invert(d.Avg_Suicides_per_100K_Pop)
                              })
                            .annotations(annotations)
                            // .textWrap(60)

                var anno = svg.append("g")
                    .call(makeAnnotations);
                anno
                    .transition()
                        .style("display", "none")
                    .transition()
                        .delay(t)
                        .style("display", "inline");

            });

        }
    	
    	
    </script>
  </body>
  

</html>
